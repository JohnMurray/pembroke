version: 2.1
commands:
  image_setup:
    description: 'Setup the container image for all CI runs'
    steps:
      - checkout
      - run:
          name: Update APT Repos
          command: apt-get update

      - run:
          name: Build Tool Setup (python)
          command: apt-get install -y python3 python3-pip && pip3 install -U pip

      - run:
          name: Build Tool Setup (conan)
          command: pip install conan cmake && conan config get
      
      - run:
          name: Conan Install 3rd Party Dependencies
          command: mkdir build && cd build && conan install ../pembroke --build=missing

      - run:
          name: Doc Tools Setup
          command: apt-get install -y doxygen && pip install -U sphinx breathe sphinx_rtd_theme
  build_pembroke:
    description: 'Build pembroke'
    parameters:
      sanitizer:
        type: string
        default: none
      build_mode:
        type: string
        default: debug
    steps:
      - run:
          name: CMake Setup
          command: ./.circleci/cmake_setup.sh --with-sanitizer '<< parameters.sanitizer >>' --compilation-mode '<< parameters.build_mode >>'
      - run:
          name: Build Library
          command: cd build && make
      - run:
          name: Test Library
          command: cd build && make test

jobs:
  build:
    docker:
      - image: ubuntu:19.10
    steps:
      - image_setup
      - build_pembroke:
          sanitizer: none